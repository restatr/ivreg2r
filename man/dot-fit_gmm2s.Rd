% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fit-gmm.R
\name{.fit_gmm2s}
\alias{.fit_gmm2s}
\title{Fit two-step efficient GMM}
\usage{
.fit_gmm2s(parsed, small = FALSE, dofminus = 0L, sdofminus = 0L, omega_fn)
}
\arguments{
\item{parsed}{A \code{parsed_formula} object from \code{.parse_formula()}.}

\item{small}{Logical: if \code{TRUE}, use \code{N-K} denominator for sigma.}

\item{dofminus}{Integer: large-sample DoF adjustment (default 0).}

\item{sdofminus}{Integer: small-sample DoF adjustment (default 0).}

\item{omega_fn}{Function: closure that takes a residual vector and returns
the L x L moment covariance matrix Omega. Built in \code{ivreg2()}.}
}
\value{
A named list with: \code{coefficients}, \code{residuals}, \code{fitted.values},
\code{vcov}, \code{sigma}, \code{df.residual}, \code{rank}, \code{r.squared}, \code{adj.r.squared},
\code{rss}, \code{r2u}, \code{r2c}, \code{mss}, \code{bread}, \code{bread_gmm}, \code{X_hat},
\code{j_stat}, \code{j_df}, \code{j_p}, \code{omega}, \code{method}.
}
\description{
Computes two-step efficient GMM estimates using the inverse of the
moment covariance matrix (Omega) as the optimal weighting matrix.
Mirrors Stata's \code{s_egmm()} (ivreg2.ado:5384-5490).
}
\details{
Algorithm:
\enumerate{
\item First step: call \code{\link[=.fit_2sls]{.fit_2sls()}} to get IV coefficients and residuals.
\item Compute Omega from step-1 residuals via \code{omega_fn}.
\item Rank-check Omega; error if singular.
\item Efficient GMM re-estimation using optimal weighting matrix W = Omega inverse.
\item Compute J statistic, R-squared, sigma, etc.
}

The efficient GMM VCV is V = N * (X'Z Omega_inv Z'X)_inv â€” the
sandwich collapses, so no separate meat computation is needed.
}
\keyword{internal}
